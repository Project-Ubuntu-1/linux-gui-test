name: GNOME Desktop via RDP
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Install GNOME Desktop and RDP
        run: |
          sudo apt-get update
          sudo apt-get install -y ubuntu-desktop-minimal
          sudo apt-get install -y xrdp
          
          # Fix GNOME for RDP
          sudo sed -i 's/port=3389/port=3390/g' /etc/xrdp/xrdp.ini
          echo "gnome-session" > ~/.xsession
          sudo systemctl enable xrdp
          sudo systemctl start xrdp

      - name: Create RDP User
        run: |
          sudo adduser rduser --gecos "" --disabled-password
          echo "rduser:Ubuntu123" | sudo chpasswd
          sudo usermod -aG sudo rduser

      - name: Start RDP Server
        run: |
          sudo systemctl restart xrdp
          echo "RDP Server started on port 3390"

      - name: Setup Pinggy Tunnel for RDP
        run: |
          echo "=========================================="
          echo "üé® GNOME DESKTOP READY FOR ARDP APP!"
          echo "=========================================="
          echo "üì± IN ARDP APP USE THESE SETTINGS:"
          echo ""
          echo "Wait for Pinggy to show your connection URL..."
          echo "It will look like: tcp://tlw0.pinggy.link:12345"
          echo ""
          echo "üîß ARDP CONNECTION SETUP:"
          echo "PC Name: [Copy the Pinggy address below]"
          echo "User Name: rduser"
          echo "Password: Ubuntu123"
          echo ""
          echo "‚è∞ This connection lasts 1 hour"
          echo "=========================================="
          
          # Start Pinggy tunnel for RDP
          ssh -o StrictHostKeyChecking=no -p 443 -R 0:localhost:3390 tcp@a.pinggy.io