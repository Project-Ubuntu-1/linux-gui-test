name: Windows Server 2022 via RDP (Fixed Tunnel)
on: [workflow_dispatch]

jobs:
  windows-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Configure Windows RDP
      run: |
        # Enable RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
        # Set resolution for phone
        Set-DisplayResolution -Width 720 -Height 1440 -Force
        
        # Create user
        $password = ConvertTo-SecureString "Windows123!" -AsPlainText -Force
        New-LocalUser -Name "termuxuser" -Password $password -FullName "Termux User" -Description "RDP User" -ErrorAction SilentlyContinue
        Add-LocalGroupMember -Group "Administrators" -Member "termuxuser"
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "termuxuser"

    - name: Install Node.js for LocalTunnel
      run: |
        # Install Node.js quickly
        Invoke-WebRequest "https://nodejs.org/dist/v18.17.0/node-v18.17.0-x64.msi" -OutFile "nodejs.msi"
        Start-Process msiexec -ArgumentList "/i nodejs.msi /quiet" -Wait
        # Refresh PATH to make npm available
        $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
        npm install -g localtunnel

    - name: Start RDP and Tunnel
      run: |
        Start-Service -Name "TermService"
        echo "RDP Service started on port 3389"
        echo "User: termuxuser"
        echo "Pass: Windows123!"
        echo ""
        echo "ðŸš€ Starting LocalTunnel..."
        
        # Start LocalTunnel for RDP port 3389
        npx localtunnel --port 3389 --subdomain termux-windows-rdp