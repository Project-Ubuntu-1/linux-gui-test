name: Windows RDP - Multiple Tunnels
on: [workflow_dispatch]

jobs:
  windows-rdp:
    runs-on: windows-latest
    timeout-minutes: 240

    steps:
    - name: Setup RDP
      run: |
        # Enable RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
        # Create user
        net user rdpuser "Pass123!" /add
        net localgroup "Administrators" "rdpuser" /add
        net localgroup "Remote Desktop Users" "rdpuser" /add
        
        Start-Service "TermService"
        Write-Output "âœ… RDP Ready on port 3389"

    - name: Download Tunnel Tools
      run: |
        # Download multiple tunnel clients
        Invoke-WebRequest "https://github.com/mmatczuk/go-http-tunnel/releases/download/2.1/http-tunnel-windows-64bit.exe" -OutFile "tunnel.exe"
        Invoke-WebRequest "https://github.com/localtunnel/localtunnel/releases/download/v2.0.2/lt-windows.exe" -OutFile "lt.exe"
        
    - name: Try localhost.run (Primary)
      run: |
        Write-Output "ðŸ”— PRIMARY: localhost.run (SSH Tunnel)"
        Write-Output "This is the most reliable free service"
        timeout 300 ssh -o StrictHostKeyChecking=no -R 80:localhost:3389 localhost.run

    - name: Try Serveo.net (Backup)
      if: always()
      run: |
        Write-Output "ðŸ”— BACKUP: serveo.net"
        timeout 300 ssh -o StrictHostKeyChecking=no -R 0:localhost:3389 serveo.net

    - name: Manual Instructions
      run: |
        Write-Output "=========================================="
        Write-Output "ðŸ”§ MANUAL TUNNEL OPTIONS"
        Write-Output "=========================================="
        Write-Output ""
        Write-Output "If automatic tunnels fail, run these manually:"
        Write-Output ""
        Write-Output "1. localhost.run (BEST):"
        Write-Output "   ssh -R 80:localhost:3389 localhost.run"
        Write-Output ""
        Write-Output "2. Serveo.net:"
        Write-Output "   ssh -R 0:localhost:3389 serveo.net"
        Write-Output ""
        Write-Output "3. LocalTunnel:"
        Write-Output "   npx localtunnel --port 3389"
        Write-Output ""
        Write-Output "ðŸ“± RDP CONNECTION INFO:"
        Write-Output "   Computer: [tunnel-url-from-above]"
        Write-Output "   Username: rdpuser"
        Write-Output "   Password: Pass123!"
        Write-Output "=========================================="