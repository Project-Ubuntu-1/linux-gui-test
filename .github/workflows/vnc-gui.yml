name: RDP Access to Windows VM

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest

    steps:
      - name: Setup RDP access and user
        run: |
          # --- RDP Service Setup ---
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Start-Service TermService
          
          # --- User Account Creation ---
          $user = "ghactionsuser"
          $password = ConvertTo-SecureString "YourStrongP@ssw0rd!" -AsPlainText -Force
          
          New-LocalUser -Name $user -Password $password -FullName "GitHub Actions User" -Description "RDP user for GitHub Actions"
          
          Add-LocalGroupMember -Group "Administrators" -Member $user
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $user

      - name: Setup Tmate and get connection info
        uses: lhotari/action-tmate@v1
        with:
          limit-access-to-actor: true

      - name: Keep job alive for RDP connection
        run: |
          # The tmate session will stay active and the job will continue to run
          # until the tmate session is terminated or the job times out (6 hours).
          # You can find the RDP tunnel details in the logs from the previous step.
          Write-Host "RDP is now active on localhost:3389."
          Write-Host "Connect using the SSH tunnel provided by the tmate action."
          # This command keeps the workflow from exiting.
          # The `lhotari/action-tmate` will print the connection details.
          while ($true) {
            Start-Sleep -Seconds 60
          }