name: Real Windows Desktop
on: [workflow_dispatch]

jobs:
  windows-gui:
    runs-on: windows-latest
    
    steps:
    - name: Enable GUI Features
      run: |
        # Windows Server comes with minimal GUI - let's enhance it
        Install-WindowsFeature Desktop-Experience
        
        # Install Windows 10-like theme and features
        winget install Microsoft.WindowsTerminal
        winget install Microsoft.PowerToys

    - name: Configure Windows Desktop
      run: |
        # Set up Windows Explorer properly
        reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced" /v "LaunchTo" /t REG_DWORD /d 1 /f
        
        # Enable sound (if needed)
        Start-Service Audiosrv
        Set-Service Audiosrv -StartupType Automatic

    - name: Start RDP Service
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Start-Service TermService
        
        # Create user with proper permissions
        $password = ConvertTo-SecureString "Windows123!" -AsPlainText -Force
        New-LocalUser -Name "winuser" -Password $password -FullName "Windows User"
        Add-LocalGroupMember -Group "Administrators" -Member "winuser"
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "winuser"

    - name: Expose via Pinggy
      run: |
        Write-Output "ðŸŽ¯ WINDOWS DESKTOP READY FOR RDP!"
        Write-Output "Waiting for Pinggy tunnel..."
        ssh -o StrictHostKeyChecking=no -R 0:localhost:3389 tcp@a.pinggy.io