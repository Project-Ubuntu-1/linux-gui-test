name: RDP Access to Windows VM

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest

    steps:
      - name: Setup RDP access and user
        run: |
          # --- RDP Service Setup ---
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Start-Service TermService
          
          # --- User Account Creation ---
          $user = "ghactionsuser"
          $password = ConvertTo-SecureString "YourStrongP@ssw0rd!" -AsPlainText -Force
          
          New-LocalUser -Name $user -Password $password -FullName "GitHub Actions User" -Description "RDP user for GitHub Actions"
          
          Add-LocalGroupMember -Group "Administrators" -Member $user
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $user

      - name: Start SSH Tunnel
        run: |
          Write-Host "ðŸŽ¯ RDP is now active and ready for connection!"
          Write-Host "User: ghactionsuser"
          Write-Host "Password: YourStrongP@ssw0rd!"
          
          # This command creates a tunnel using a persistent service like Pinggy.
          # The -T option disables pseudo-terminal allocation, which can cause issues.
          # The -N option prevents remote command execution.
          # The -R option forwards the remote port (0) to the local RDP port (3389).
          # This command will hold the job open for as long as the SSH connection is active.
          ssh -T -o StrictHostKeyChecking=no -N -R 0:localhost:3389 tcp@a.pinggy.io