name: RDP Access to Windows VM

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest

    steps:
      - name: Setup RDP access
        run: |
          # Set the RDP port to a common value, 3389.
          # The SSH tunnel will forward this port.
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Start-Service TermService
          
          # Create a new local user for RDP access.
          # Use a strong password and remember it.
          $user = "ghauser"
          $pass = "YourStrongP@ssw0rd!"
          
          net user $user $pass /add
          net localgroup administrators $user /add
          net localgroup "Remote Desktop Users" $user /add

      - name: Start SSH Tunnel
        run: |
          # Install the SSH client if not present (it is by default on Windows runners).
          # It's good practice to ensure it's there.
          if (-not (Get-Command ssh -ErrorAction SilentlyContinue)) {
            Write-Host "SSH client not found. This step might fail."
          }

          # This command creates a persistent tunnel using pinggy.io.
          # It forwards the local RDP port (3389) to a publicly accessible host.
          # The job will remain active as long as this connection is live.
          # The output will provide the RDP address you need to connect.
          Write-Output "ðŸŽ¯ RDP is now active and ready for connection!"
          Write-Output "User: ghauser"
          Write-Output "Password: YourStrongP@ssw0rd!"
          
          # This command will block, keeping the GitHub Actions job running.
          # The connection details will be printed to the logs.
          ssh -o StrictHostKeyChecking=no -N -R 0:localhost:3389 tcp@a.pinggy.io