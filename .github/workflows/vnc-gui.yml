name: Windows Server 2022 RDP - WORKING
on: [workflow_dispatch]

jobs:
  windows-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Configure Windows RDP
      run: |
        # Enable RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
        # Create user
        net user termuxuser "Windows123!" /add
        net localgroup "Administrators" "termuxuser" /add
        net localgroup "Remote Desktop Users" "termuxuser" /add
        Start-Service -Name "TermService"

    - name: Install Chrome
      run: |
        Invoke-WebRequest "https://dl.google.com/chrome/install/latest/chrome_installer.exe" -OutFile "chrome.exe"
        Start-Process -FilePath "chrome.exe" -Args "/silent /install" -Wait
        Remove-Item "chrome.exe"

    - name: Start Cloudflared Tunnel (THIS WILL WORK)
      run: |
        # Download cloudflared
        Invoke-WebRequest "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "cloudflared.exe"
        
        echo "=========================================="
        echo "ðŸªŸ WINDOWS SERVER 2022 READY!"
        echo "=========================================="
        echo "RDP Service: RUNNING"
        echo "Username: termuxuser"
        echo "Password: Windows123!"
        echo ""
        echo "ðŸš€ Starting Cloudflare Tunnel..."
        echo "WAIT FOR TUNNEL URL..."
        echo "=========================================="
        
        # Start cloudflared tunnel for RDP
        .\cloudflared.exe tunnel --url rdp://localhost:3389