name: Windows RDP - Free Tunnel
on: [workflow_dispatch]

jobs:
  windows-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Setup RDP and User
      run: |
        # Enable RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
        # Create user with proper permissions
        $password = "Pass123!"
        net user rdpuser $password /add /Y
        net localgroup "Administrators" "rdpuser" /add
        net localgroup "Remote Desktop Users" "rdpuser" /add
        
        # Set password to never expire
        WMIC USERACCOUNT WHERE "Name='rdpuser'" SET PasswordExpires=FALSE
        
        # Start RDP service
        Start-Service "TermService"
        Set-Service "TermService" -StartupType Automatic
        
        Write-Output "RDP configured on port 3389"
        Write-Output "Username: rdpuser"
        Write-Output "Password: $password"

    - name: Install and Configure Free Tunnel
      run: |
        # Method 1: Try localhost.run (SSH tunnel) - Most reliable
        Write-Output "=== OPTION 1: localhost.run (SSH Tunnel) ==="
        
        # Install OpenSSH client if not present
        Get-WindowsCapability -Online | Where-Object Name -like 'OpenSSH.Client*' | Add-WindowsCapability -Online
        
        Write-Output "SSH tunnel will be established in next step"

    - name: Start localhost.run Tunnel (Most Reliable)
      run: |
        # localhost.run - Free, no signup, works great
        Write-Output "ðŸš€ Starting localhost.run tunnel..."
        Write-Output "This will show your public RDP URL in 10-20 seconds"
        Write-Output "Waiting for tunnel..."
        
        ssh -o StrictHostKeyChecking=no -R 80:localhost:3389 localhost.run

    - name: Alternative Tunnel Methods
      run: |
        Write-Output "=== Backup Tunnel Methods ==="
        Write-Output "If localhost.run fails, try these manually:"
        Write-Output ""
        Write-Output "1. serveo.net:"
        Write-Output "   ssh -R 0:localhost:3389 serveo.net"
        Write-Output ""
        Write-Output "2. LocalXpose (download first):"
        Write-Output "   ./loclx tunnel tcp --port 3389"
        Write-Output ""
        Write-Output "3. PageKite:"
        Write-Output "   python pagekite.py 3389 yourname.pagekite.me"