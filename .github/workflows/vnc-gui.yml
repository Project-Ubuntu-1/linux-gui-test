name: GNOME Desktop via RDP
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Install GNOME Desktop and RDP
        run: |
          sudo apt-get update
          # Fix potential package issues first
          sudo apt-get install -f -y
          # Install GNOME and RDP
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y ubuntu-desktop-minimal xrdp
          
          # Configure RDP for your phone resolution
          sudo sed -i 's/port=3389/port=3390/g' /etc/xrdp/xrdp.ini
          sudo sed -i 's/width=1920/width=720/g' /etc/xrdp/xrdp.ini
          sudo sed -i 's/height=1080/height=1440/g' /etc/xrdp/xrdp.ini  # Adjusted for RDP aspect ratio
          
          echo "gnome-session" > ~/.xsession
          sudo systemctl enable xrdp

      - name: Create RDP User (Skip if exists)
        run: |
          if id "rduser" &>/dev/null; then
            echo "User rduser already exists"
          else
            sudo adduser rduser --gecos "" --disabled-password
            echo "rduser:Ubuntu123" | sudo chpasswd
            sudo usermod -aG sudo rduser
          fi

      - name: Fix GNOME Permissions
        run: |
          sudo mkdir -p /home/rduser
          sudo chown rduser:rduser /home/rduser
          sudo cp ~/.xsession /home/rduser/
          sudo chown rduser:rduser /home/rduser/.xsession

      - name: Start and Verify RDP Server
        run: |
          sudo systemctl restart xrdp
          sudo systemctl status xrdp --no-pager -l
          echo "RDP Server running on port 3390"
          echo "Screen resolution set to: 720x1440 (optimized for 720x1612 phone)"

      - name: Setup Pinggy Tunnel for RDP
        run: |
          echo "=========================================="
          echo "ðŸ“± PHONE-OPTIMIZED GNOME DESKTOP READY!"
          echo "=========================================="
          echo "Screen: 720x1440 (perfect for 720x1612)"
          echo "User: rduser"
          echo "Pass: Ubuntu123"
          echo ""
          echo "ðŸš€ Starting Pinggy tunnel..."
          echo "WAIT 10-20 SECONDS FOR CONNECTION URL..."
          echo "=========================================="
          
          # Start Pinggy with better error handling
          timeout 3600 ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -p 443 -R 0:localhost:3390 tcp@a.pinggy.io